return function(newParent)
	local Players = game:GetService("Players")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")
	local TweenService = game:GetService("TweenService")
	local CollectionService = game:GetService("CollectionService")

	local player = Players.LocalPlayer
	local playerGui = player:WaitForChild("PlayerGui")
	local Workspace = game:GetService("Workspace")
	local CurrentCamera = Workspace.CurrentCamera

	local function safeWaitChar()
		if not player.Character then
			player.CharacterAdded:Wait()
		end
	end

	local Remotes = newParent:WaitForChild("Remotes")
	local PlaceRemote = Remotes:WaitForChild("Place")
	local DestroyItemRemote = Remotes:FindFirstChild("DestroyItemRemote") or ReplicatedStorage:FindFirstChild("DestroyItemRemote")
	local ThrowItemEvent = ReplicatedStorage:WaitForChild("ThrowItemEvent")
	local PlaceBuildRemoveItemEvent = ReplicatedStorage:WaitForChild("PlaceBuildRemoveItemEvent")
	local UnEquipRemote = playerGui.TheInventorySystem:WaitForChild("UnEquipRemote")

	local BuildReplicatorPart = Workspace:WaitForChild("BuildReplicatorPart")
	local TheInventorySystem = playerGui:WaitForChild("TheInventorySystem")
	local InventoryMenu = TheInventorySystem:WaitForChild("InventoryMenu")
	local HotbarLine = InventoryMenu["Inventory Section"].Inv:WaitForChild("HotbarLine")
	local HotbarContainer = TheInventorySystem:WaitForChild("Hotbar")
	local SlotSelected = TheInventorySystem:WaitForChild("SlotSelected")
	local InvGui = InventoryMenu["Inventory Section"].Inv
	local StorageGui = InventoryMenu["HomeCore Section"].Storage

	local MobileButtons = playerGui:WaitForChild("MobileButtons")
	local RotateGui = MobileButtons:WaitForChild("Rotate")
	local RotateBtn = RotateGui:WaitForChild("RotateButton")
	local ForwardGui = MobileButtons:WaitForChild("MoveForward")
	local ForwardBtn = ForwardGui:WaitForChild("ForwardButton")
	local BackGui = MobileButtons:WaitForChild("MoveBackward")
	local BackBtn = BackGui:WaitForChild("BackwardButton")

	local XYZ = playerGui:WaitForChild("XYZ")
	local Xbtn = XYZ:WaitForChild("X")
	local Ybtn = XYZ:WaitForChild("Y")
	local Zbtn = XYZ:WaitForChild("Z")
	local CheckmarkGUI = XYZ:WaitForChild("CheckmarkGUI")

	local defaultDistance = 8.25
	local distance = defaultDistance
	local rotateAccum = Vector3.new(0,0,0)
	local placingEnabled = false
	local rotating = false
	local forwardHold = false
	local backHold = false
	local axisX, axisY, axisZ = true, false, false

	local function updateMobileSizes()
		local size = 120
		local screenX = RotateBtn.Screen.AbsoluteSize.X
		local screenY = RotateBtn.Screen.AbsoluteSize.Y
		if math.min(screenX, screenY) > 500 then
			size = 70
		end
		if UserInputService.TouchEnabled then
			RotateGui.Enabled = true
			RotateBtn.Size = UDim2.new(0, size, 0, size)
			ForwardGui.Enabled = true
			ForwardBtn.Size = UDim2.new(0, size, 0, size)
			BackGui.Enabled = true
			BackBtn.Size = UDim2.new(0, size, 0, size)
		else
			RotateGui.Enabled = false
			ForwardGui.Enabled = false
			BackGui.Enabled = false
		end
	end

	local function refreshReferences()
		player = Players.LocalPlayer
		safeWaitChar()
		playerGui = player:WaitForChild("PlayerGui")
		CurrentCamera = Workspace.CurrentCamera
		TheInventorySystem = playerGui:WaitForChild("TheInventorySystem")
		InventoryMenu = TheInventorySystem:WaitForChild("InventoryMenu")
		HotbarLine = InventoryMenu["Inventory Section"].Inv:WaitForChild("HotbarLine")
		HotbarContainer = TheInventorySystem:WaitForChild("Hotbar")
		SlotSelected = TheInventorySystem:WaitForChild("SlotSelected")
		InvGui = InventoryMenu["Inventory Section"].Inv
		StorageGui = InventoryMenu["HomeCore Section"].Storage
		XYZ = playerGui:WaitForChild("XYZ")
		Xbtn = XYZ:WaitForChild("X")
		Ybtn = XYZ:WaitForChild("Y")
		Zbtn = XYZ:WaitForChild("Z")
		RotateGui = playerGui.MobileButtons:WaitForChild("Rotate")
		RotateBtn = RotateGui:WaitForChild("RotateButton")
		ForwardGui = playerGui.MobileButtons:WaitForChild("MoveForward")
		ForwardBtn = ForwardGui:WaitForChild("ForwardButton")
		BackGui = playerGui.MobileButtons:WaitForChild("MoveBackward")
		BackBtn = BackGui:WaitForChild("BackwardButton")
		updateMobileSizes()
	end

	refreshReferences()

	UserInputService.InputBegan:Connect(function(input, processed)
		if input.KeyCode == Enum.KeyCode.V and placingEnabled then
			forwardHold = true
		end
		if input.KeyCode == Enum.KeyCode.B and placingEnabled then
			backHold = true
		end
		if input.KeyCode == Enum.KeyCode.R and placingEnabled then
			if not rotating then
				rotating = true
				spawn(function()
					while rotating do
						if axisX then
							rotateAccum = rotateAccum + Vector3.new(45,0,0)
						elseif axisY then
							rotateAccum = rotateAccum + Vector3.new(0,45,0)
						elseif axisZ then
							rotateAccum = rotateAccum + Vector3.new(0,0,45)
						end
						wait(0.25)
					end
				end)
			end
		end
	end)

	UserInputService.InputEnded:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.V and placingEnabled then
			forwardHold = false
		end
		if input.KeyCode == Enum.KeyCode.B and placingEnabled then
			backHold = false
		end
		if input.KeyCode == Enum.KeyCode.R and placingEnabled then
			rotating = false
		end
	end)

	ForwardBtn.MouseButton1Down:Connect(function()
		if placingEnabled then
			forwardHold = true
		end
	end)
	ForwardBtn.MouseButton1Up:Connect(function()
		if placingEnabled then
			forwardHold = false
		end
	end)

	BackBtn.MouseButton1Down:Connect(function()
		if placingEnabled then
			backHold = true
		end
	end)
	BackBtn.MouseButton1Up:Connect(function()
		if placingEnabled then
			backHold = false
		end
	end)

	Xbtn.Activated:Connect(function()
		if placingEnabled then
			axisX, axisY, axisZ = true, false, false
			Xbtn.Image = "rbxassetid://16562623753"
			Ybtn.Image = "rbxassetid://16562604900"
			Zbtn.Image = "rbxassetid://16562606076"
		end
	end)
	Ybtn.Activated:Connect(function()
		if placingEnabled then
			axisX, axisY, axisZ = false, true, false
			Xbtn.Image = "rbxassetid://16562628313"
			Ybtn.Image = "rbxassetid://16562630011"
			Zbtn.Image = "rbxassetid://16562606076"
		end
	end)
	Zbtn.Activated:Connect(function()
		if placingEnabled then
			axisX, axisY, axisZ = false, false, true
			Xbtn.Image = "rbxassetid://16562628313"
			Ybtn.Image = "rbxassetid://16562604900"
			Zbtn.Image = "rbxassetid://16562632722"
		end
	end)

	local function getHotbarSlotGui()
		local slot = SlotSelected.Value
		local slotGui
		if slot == 2 then slotGui = HotbarLine:WaitForChild("InvSlot2")
		elseif slot == 3 then slotGui = HotbarLine:WaitForChild("InvSlot3")
		elseif slot == 4 then slotGui = HotbarLine:WaitForChild("InvSlot4")
		elseif slot == 5 then slotGui = HotbarLine:WaitForChild("InvSlot5")
		elseif slot == 6 then slotGui = HotbarLine:WaitForChild("InvSlot6")
		elseif slot == 7 then slotGui = HotbarLine:WaitForChild("InvSlot7")
		elseif slot == 8 then slotGui = HotbarLine:WaitForChild("InvSlot8")
		elseif slot == 9 then slotGui = HotbarLine:WaitForChild("InvSlot9")
		elseif slot == 10 then slotGui = HotbarLine:WaitForChild("InvSlot10")
		end
		return slotGui
	end

	local function findSelectedInventoryButton(slotGui)
		for _, child in ipairs(slotGui:GetChildren()) do
			if child:IsA("ImageButton") then
				return child
			end
		end
		return nil
	end

	local canPlaceRegardless = function(instance)
		if not instance then return true end
		local hasTag = false
		if instance and typeof(instance) == "Instance" then
			if CollectionService:HasTag(instance, "ETHICAL") then
				hasTag = true
			else
				local possible = instance:FindFirstChild("Tags")
				if possible and possible:IsA("Folder") then
					if possible:FindFirstChild("ETHICAL") then
						hasTag = true
					end
				end
			end
		end
		return not hasTag
	end

	local function onEquipped()
		placingEnabled = true
		refreshReferences()
		BuildReplicatorPart:ClearAllChildren()
		rotateAccum = Vector3.new(0,0,0)
		distance = defaultDistance
		if not UserInputService.TouchEnabled then
			TheInventorySystem.KeyboardControlsList.ItemControls.Image = "rbxassetid://17223334384"
		end
		XYZ.Enabled = true
		RotateGui.Enabled = UserInputService.TouchEnabled
		ForwardGui.Enabled = UserInputService.TouchEnabled
		BackGui.Enabled = UserInputService.TouchEnabled

		while placingEnabled do
			CurrentCamera = Workspace.CurrentCamera
			local camPos = CurrentCamera.CFrame.Position
			if forwardHold and distance < 12.5 then distance = distance + 0.3 end
			if backHold and distance > 4 then distance = distance - 0.3 end

			local targetCFrame = CFrame.new(camPos + CurrentCamera.CFrame.LookVector * distance) * CFrame.fromEulerAnglesXYZ(math.rad(rotateAccum.X), math.rad(rotateAccum.Y), math.rad(rotateAccum.Z))
			local tween = TweenService:Create(BuildReplicatorPart, TweenInfo.new(0.25), {CFrame = targetCFrame})
			tween:Play()
			tween.Completed:Wait()

			local collision = false
			for _, child in ipairs(BuildReplicatorPart:GetChildren()) do
				if child:IsA("Part") or child:IsA("MeshPart") then
					for _, touching in ipairs(child:GetTouchingParts()) do
						if touching and touching.Parent and touching.Parent ~= BuildReplicatorPart and touching.Parent ~= player.Character then
							collision = true
							break
						end
					end
				end
				if collision then break end
			end
			if collision then
				CheckmarkGUI.Image = "rbxassetid://16629629912"
			else
				CheckmarkGUI.Image = "rbxassetid://16629665367"
			end
			wait()
		end
	end

	local function onUnequipped()
		placingEnabled = false
		XYZ.Enabled = false
		RotateGui.Enabled = false
		ForwardGui.Enabled = false
		BackGui.Enabled = false
		BuildReplicatorPart:ClearAllChildren()
	end

	newParent.Equipped:Connect(onEquipped)
	newParent.Unequipped:Connect(onUnequipped)

	local function placeAction()
		local slotGui = getHotbarSlotGui()
		if not slotGui then return end
		local selectedBtn = findSelectedInventoryButton(slotGui)
		if not selectedBtn then return end

		local invParent = selectedBtn.Parent
		local grandParent = invParent and invParent.Parent
		local highestParent = grandParent and grandParent.Parent

		if highestParent == InvGui then
			if canPlaceRegardless(selectedBtn) then
				-- item without ETHICAL tag -> don't mark for deletion
			else
				StorageGui[invParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name):SetAttribute("DeleteItem", true)
			end
		elseif highestParent == StorageGui then
			if canPlaceRegardless(selectedBtn) then
				-- item without ETHICAL tag -> don't mark for deletion
			else
				InvGui[invParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name):SetAttribute("DeleteItem", true)
			end
		end

		for _, hb in ipairs(HotbarContainer:GetChildren()) do
			if tonumber(hb.Name:match("%d+$")) == SlotSelected.Value then
				for _, child in ipairs(hb:GetChildren()) do
					if child.Name == newParent.Name then
						child:Destroy()
					end
				end
			end
		end

		if placingEnabled then
			UnEquipRemote:FireServer()
			PlaceBuildRemoveItemEvent:FireServer(slotGui, selectedBtn)
			if PlaceRemote then
				PlaceRemote:FireServer()
			end
			if PlaceRemote and DestroyItemRemote and (not canPlaceRegardless(selectedBtn)) then
				wait(PlaceRemote.TimeLength or 0.1)
				DestroyItemRemote:FireServer()
			end
		end
	end

	newParent.Activated:Connect(placeAction)

	RotateBtn.MouseButton1Down:Connect(function()
		if placingEnabled and not rotating then
			rotating = true
			spawn(function()
				while rotating do
					if axisX then rotateAccum = rotateAccum + Vector3.new(45,0,0)
					elseif axisY then rotateAccum = rotateAccum + Vector3.new(0,45,0)
					elseif axisZ then rotateAccum = rotateAccum + Vector3.new(0,0,45)
					end
					wait(0.25)
				end
			end)
		end
	end)
	RotateBtn.MouseButton1Up:Connect(function()
		rotating = false
	end)

	UserInputService.InputBegan:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.T then
			local slotGui = getHotbarSlotGui()
			if not slotGui then return end
			local selectedBtn = findSelectedInventoryButton(slotGui)
			if not selectedBtn then return end

			for _, hb in ipairs(HotbarContainer:GetChildren()) do
				if tonumber(hb.Name:match("%d+$")) == SlotSelected.Value then
					for _, child in ipairs(hb:GetChildren()) do
						if child.Name == newParent.Name then
							child:Destroy()
						end
					end
				end
			end

			UnEquipRemote:FireServer()
			ThrowItemEvent:FireServer(slotGui, HotbarLine, newParent, selectedBtn, player.Character or player.CharacterAdded:Wait(), (CurrentCamera.CFrame.LookVector * 100 - (player.Character and player.Character:FindFirstChild("Torso") and player.Character.Torso.Position or Vector3.new())) .Unit * 30)
			wait()
			if selectedBtn.Parent and selectedBtn.Parent.Parent and selectedBtn.Parent.Parent.Parent == InvGui then
				if not canPlaceRegardless(selectedBtn) then
					StorageGui[selectedBtn.Parent.Parent.Name][selectedBtn.Parent.Name]:FindFirstChild(selectedBtn.Name):SetAttribute("DeleteItem", true)
				end
			elseif selectedBtn.Parent and selectedBtn.Parent.Parent and selectedBtn.Parent.Parent.Parent == StorageGui then
				if not canPlaceRegardless(selectedBtn) then
					InvGui[selectedBtn.Parent.Parent.Name][selectedBtn.Parent.Name]:FindFirstChild(selectedBtn.Name):SetAttribute("DeleteItem", true)
				end
			end
			if DestroyItemRemote and (not canPlaceRegardless(selectedBtn)) then
				DestroyItemRemote:FireServer()
			end
		end
	end)

end
