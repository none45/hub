local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local workspace = workspace

return function(newParent)
    local player = Players.LocalPlayer
    local playerGui = player and player:WaitForChild("PlayerGui")
    local tool = newParent
    local remotesFolder = tool:WaitForChild("Remotes")
    local Remotes = {
        Equipped = remotesFolder:WaitForChild("Equipped"),
        Place = remotesFolder:FindFirstChild("Place"),
        DestroyItemRemote = remotesFolder:FindFirstChild("DestroyItemRemote"),
        UnEquipRemote = playerGui and playerGui.TheInventorySystem:FindFirstChild("UnEquipRemote")
    }
    local PlaceBuildRemoveItemEvent = ReplicatedStorage:FindFirstChild("PlaceBuildRemoveItemEvent")
    local ThrowItemEvent = ReplicatedStorage:FindFirstChild("ThrowItemEvent")
    local BuildReplicator = workspace:WaitForChild("BuildReplicatorPart")
    local placeSound = tool:FindFirstChild("PlaceSound")
    local cam = workspace.CurrentCamera

    local settings = {
        distance = 8.25,
        minDistance = 4,
        maxDistance = 12.5,
        rotateStep = 45,
        rotateHoldInterval = 0.25
    }

    local state = {
        active = false,
        rotating = false,
        rotateAxis = "X",
        rotateVector = Vector3.new(0,0,0),
        forwardHeld = false,
        backwardHeld = false,
        rotatingHold = false,
        canRotateLoop = true,
        invalidPlacement = false,
        connections = {}
    }

    local guiCache = {}
    local function safeFind(path)
        local s = playerGui
        for part in string.gmatch(path, "[^%.]+") do
            if not s then return nil end
            s = s:FindFirstChild(part)
        end
        return s
    end

    local function getHotbarLine()
        local invSys = playerGui and playerGui.TheInventorySystem
        if not invSys then return nil end
        return invSys.InventoryMenu["Inventory Section"].Inv.HotbarLine
    end

    local function getHotbarContainer()
        local invSys = playerGui and playerGui.TheInventorySystem
        if not invSys then return nil end
        return invSys.InventoryMenu["Inventory Section"].Inv
    end

    local function getStorageContainer()
        local invSys = playerGui and playerGui.TheInventorySystem
        if not invSys then return nil end
        return invSys.InventoryMenu["HomeCore Section"].Storage
    end

    local function getSlotGui(slotNum)
        local hotbarLine = getHotbarLine()
        if not hotbarLine then return nil end
        if slotNum == 1 then return hotbarLine.InvSlot1 end
        if slotNum == 2 then return hotbarLine.InvSlot2 end
        if slotNum == 3 then return hotbarLine.InvSlot3 end
        if slotNum == 4 then return hotbarLine.InvSlot4 end
        if slotNum == 5 then return hotbarLine.InvSlot5 end
        if slotNum == 6 then return hotbarLine.InvSlot6 end
        if slotNum == 7 then return hotbarLine.InvSlot7 end
        if slotNum == 8 then return hotbarLine.InvSlot8 end
        if slotNum == 9 then return hotbarLine.InvSlot9 end
        if slotNum == 10 then return hotbarLine.InvSlot10 end
        return nil
    end

    local function findFirstImageButton(container)
        if not container then return nil end
        for _, child in ipairs(container:GetChildren()) do
            if child:IsA("ImageButton") then
                return child
            end
        end
        return nil
    end

    local function rebuildPreview()
        if not state.active then return end
        local currentCam = workspace.CurrentCamera
        BuildReplicator:ClearAllChildren()
        local buildTemplate = ReplicatedStorage.Builds and ReplicatedStorage.Builds[tool.Name]
        if not buildTemplate then return end
        for _, v in ipairs(buildTemplate:GetDescendants()) do
            if v:IsA("Part") or v:IsA("MeshPart") then
                local clone = v:Clone()
                clone.Parent = BuildReplicator
                clone.CFrame = BuildReplicator.CFrame * CFrame.new(v.Position)
                if v.Name ~= "BarrierPart" and v.Name ~= "Epart" and v.Name ~= "PrimPart" and v.Name ~= "OpenPos" then
                    clone.Transparency = 0.4
                end
                clone.CollisionGroup = "Builds"
                local weld = Instance.new("WeldConstraint")
                weld.Part0 = BuildReplicator
                weld.Part1 = clone
                weld.Parent = clone
            end
        end
    end

    local function updateReplicatorCFrame()
        if not state.active then return end
        cam = workspace.CurrentCamera
        local lookPos = cam.CFrame.Position + cam.CFrame.LookVector * settings.distance
        local rot = CFrame.fromEulerAnglesXYZ(math.rad(state.rotateVector.X), math.rad(state.rotateVector.Y), math.rad(state.rotateVector.Z))
        local target = CFrame.new(lookPos) * rot
        local tween = TweenService:Create(BuildReplicator, TweenInfo.new(0.25), {CFrame = target})
        tween:Play()
    end

    local function checkPlacementValidity()
        local invalid = false
        for _, child in ipairs(BuildReplicator:GetChildren()) do
            if child:IsA("Part") or child:IsA("MeshPart") then
                for _, touching in ipairs(child:GetTouchingParts()) do
                    if touching and touching.Parent then
                        if touching.Parent ~= BuildReplicator and touching ~= BuildReplicator and touching.Parent ~= player.Character then
                            local attr = touching:GetAttribute("AntiBuild") or touching.Parent:GetAttribute("AntiBuild")
                            if not attr then
                                invalid = true
                                break
                            end
                        end
                    end
                end
                if invalid then break end
            end
        end
        state.invalidPlacement = invalid
        local xyzGui = playerGui and playerGui:FindFirstChild("XYZ")
        if xyzGui and xyzGui:FindFirstChild("CheckmarkGUI") then
            local img = xyzGui.CheckmarkGUI
            if invalid then
                img.Image = "rbxassetid://16629629912"
            else
                img.Image = "rbxassetid://16629665367"
            end
        end
        return not invalid
    end

    local function startRotateLoop()
        if state.rotatingHold then return end
        state.rotatingHold = true
        state.canRotateLoop = false
        if state.rotateAxis == "X" then state.rotateVector = state.rotateVector + Vector3.new(settings.rotateStep,0,0)
        elseif state.rotateAxis == "Y" then state.rotateVector = state.rotateVector + Vector3.new(0,settings.rotateStep,0)
        else state.rotateVector = state.rotateVector + Vector3.new(0,0,settings.rotateStep) end
        task.wait(settings.rotateHoldInterval)
        while state.rotating do
            if state.rotateAxis == "X" then state.rotateVector = state.rotateVector + Vector3.new(settings.rotateStep,0,0)
            elseif state.rotateAxis == "Y" then state.rotateVector = state.rotateVector + Vector3.new(0,settings.rotateStep,0)
            else state.rotateVector = state.rotateVector + Vector3.new(0,0,settings.rotateStep) end
            updateReplicatorCFrame()
            task.wait(settings.rotateHoldInterval)
        end
        state.rotatingHold = false
        state.canRotateLoop = true
    end

    local function onEquip()
        state.active = true
        cam = workspace.CurrentCamera
        BuildReplicator.CFrame = CFrame.new(cam.CFrame.Position + cam.CFrame.LookVector * settings.distance) * CFrame.fromEulerAnglesXYZ(math.rad(state.rotateVector.X), math.rad(state.rotateVector.Y), math.rad(state.rotateVector.Z))
        rebuildPreview()
        updateReplicatorCFrame()
        if Remotes.Equipped then
            pcall(function() Remotes.Equipped:FireServer(player.Character or player.CharacterAdded:Wait()) end)
        end
        task.spawn(function()
            while state.active do
                cam = workspace.CurrentCamera
                if state.forwardHeld and settings.distance < settings.maxDistance then
                    settings.distance = math.min(settings.maxDistance, settings.distance + 0.3)
                elseif state.backwardHeld and settings.distance > settings.minDistance then
                    settings.distance = math.max(settings.minDistance, settings.distance - 0.3)
                end
                updateReplicatorCFrame()
                checkPlacementValidity()
                task.wait(0.05)
            end
        end)
    end

    local function onUnequip()
        state.active = false
        BuildReplicator:ClearAllChildren()
        local invSys = playerGui and playerGui.TheInventorySystem
        if invSys and invSys.KeyboardControlsList and invSys.KeyboardControlsList.ItemControls then
            invSys.KeyboardControlsList.ItemControls.Image = "rbxassetid://110730554989882"
        end
    end

    local function placeAction()
        if not state.active then return end
        if not checkPlacementValidity() then return end
        local slotSelected = playerGui and playerGui.TheInventorySystem and playerGui.TheInventorySystem.SlotSelected
        local slotNum = slotSelected and slotSelected.Value or 1
        local slotGui = getSlotGui(slotNum)
        local imageBtn = findFirstImageButton(slotGui)
        if imageBtn then
            local inv = getHotbarContainer()
            local storage = getStorageContainer()
            if imageBtn.Parent and imageBtn.Parent.Parent and imageBtn.Parent.Parent.Parent == inv and storage then
                local a = "DeleteItem"
                storage[imageBtn.Parent.Parent.Name][imageBtn.Parent.Name]:FindFirstChild(imageBtn.Name):SetAttribute(a, true)
            elseif imageBtn.Parent and imageBtn.Parent.Parent and imageBtn.Parent.Parent.Parent == storage and inv then
                local a = "DeleteItem"
                inv[imageBtn.Parent.Parent.Name][imageBtn.Parent.Name]:FindFirstChild(imageBtn.Name):SetAttribute(a, true)
            end
        end
        if Remotes.UnEquipRemote then
            pcall(function() Remotes.UnEquipRemote:FireServer() end)
        end
        if PlaceBuildRemoveItemEvent and imageBtn then
            pcall(function() PlaceBuildRemoveItemEvent:FireServer(slotGui, imageBtn) end)
        end
        if placeSound and placeSound.IsA and placeSound:IsA("Sound") then
            pcall(function() placeSound:Play() end)
            task.wait(placeSound.TimeLength)
        end
        if Remotes.DestroyItemRemote then
            pcall(function() Remotes.DestroyItemRemote:FireServer() end)
        end
    end

    local function throwAction()
        if not state.active then return end
        local slotSelected = playerGui and playerGui.TheInventorySystem and playerGui.TheInventorySystem.SlotSelected
        local slotNum = slotSelected and slotSelected.Value or 1
        local slotGui = getSlotGui(slotNum)
        local imageBtn = findFirstImageButton(slotGui)
        for _, v in ipairs(getHotbarLine():GetChildren()) do
            if tonumber(v.Name:match("%d+$")) == slotNum then
                for _, child in ipairs(v:GetChildren()) do
                    if child.Name == tool.Name then
                        child:Destroy()
                    end
                end
            end
        end
        if Remotes.UnEquipRemote then
            pcall(function() Remotes.UnEquipRemote:FireServer() end)
        end
        local char = player.Character or player.CharacterAdded:Wait()
        local lookVec = workspace.CurrentCamera.CFrame.LookVector
        local throwVec = (lookVec * 100 - (char:FindFirstChild("Torso") and char.Torso.Position or (char.PrimaryPart and char.PrimaryPart.Position) or Vector3.new())) 
        local velocity = throwVec.Unit * 30
        if ThrowItemEvent then
            pcall(function() ThrowItemEvent:FireServer(slotGui, getHotbarLine(), tool, imageBtn, char, velocity) end)
        end
        if Remotes.DestroyItemRemote then
            pcall(function() Remotes.DestroyItemRemote:FireServer() end)
        end
        if imageBtn and imageBtn.Parent and imageBtn.Parent.Parent and imageBtn.Parent.Parent.Parent == getHotbarContainer() then
            local storage = getStorageContainer()
            if storage then
                storage[imageBtn.Parent.Parent.Name][imageBtn.Parent.Name]:FindFirstChild(imageBtn.Name):SetAttribute("DeleteItem", true)
                return
            end
        end
        if imageBtn and imageBtn.Parent and imageBtn.Parent.Parent and imageBtn.Parent.Parent.Parent == getStorageContainer() then
            local inv = getHotbarContainer()
            if inv then
                inv[imageBtn.Parent.Parent.Name][imageBtn.Parent.Name]:FindFirstChild(imageBtn.Name):SetAttribute("DeleteItem", true)
            end
        end
    end

    local function onInputBegan(input, gameProcessed)
        if gameProcessed then return end
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.V and state.active then
                state.forwardHeld = true
            elseif input.KeyCode == Enum.KeyCode.B and state.active then
                state.backwardHeld = true
            elseif input.KeyCode == Enum.KeyCode.R and state.active and state.canRotateLoop then
                state.rotating = true
                startRotateLoop()
            elseif input.KeyCode == Enum.KeyCode.T and state.active then
                throwAction()
            elseif input.KeyCode == Enum.KeyCode.X and state.active then
                state.rotateAxis = "X"
            elseif input.KeyCode == Enum.KeyCode.Y and state.active then
                state.rotateAxis = "Y"
            elseif input.KeyCode == Enum.KeyCode.Z and state.active then
                state.rotateAxis = "Z"
            end
        end
    end

    local function onInputEnded(input)
        if input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.V and state.active then
                state.forwardHeld = false
            elseif input.KeyCode == Enum.KeyCode.B and state.active then
                state.backwardHeld = false
            elseif input.KeyCode == Enum.KeyCode.R and state.active then
                state.rotating = false
            end
        end
    end

    local function wireGuiButtons()
        local mobile = playerGui and playerGui:FindFirstChild("MobileButtons")
        if not mobile then return end
        local rotate = mobile:FindFirstChild("Rotate")
        local forward = mobile:FindFirstChild("MoveForward")
        local backward = mobile:FindFirstChild("MoveBackward")
        if rotate and rotate:FindFirstChild("RotateButton") then
            local btn = rotate.RotateButton
            state.connections.rotateDown = btn.MouseButton1Down:Connect(function()
                if state.canRotateLoop then
                    state.rotating = true
                    startRotateLoop()
                end
            end)
            state.connections.rotateUp = btn.MouseButton1Up:Connect(function()
                state.rotating = false
            end)
        end
        if forward and forward:FindFirstChild("ForwardButton") then
            local fbtn = forward.ForwardButton
            state.connections.forwardDown = fbtn.MouseButton1Down:Connect(function()
                state.forwardHeld = true
            end)
            state.connections.forwardUp = fbtn.MouseButton1Up:Connect(function()
                state.forwardHeld = false
            end)
        end
        if backward and backward:FindFirstChild("BackwardButton") then
            local bbtn = backward.BackwardButton
            state.connections.backwardDown = bbtn.MouseButton1Down:Connect(function()
                state.backwardHeld = true
            end)
            state.connections.backwardUp = bbtn.MouseButton1Up:Connect(function()
                state.backwardHeld = false
            end)
        end

        local xyz = playerGui and playerGui:FindFirstChild("XYZ")
        if xyz then
            if xyz:FindFirstChild("X") then
                state.connections.xBtn = xyz.X.Activated:Connect(function()
                    if state.active then state.rotateAxis = "X" end
                end)
            end
            if xyz:FindFirstChild("Y") then
                state.connections.yBtn = xyz.Y.Activated:Connect(function()
                    if state.active then state.rotateAxis = "Y" end
                end)
            end
            if xyz:FindFirstChild("Z") then
                state.connections.zBtn = xyz.Z.Activated:Connect(function()
                    if state.active then state.rotateAxis = "Z" end
                end)
            end
        end
    end

    local function connectTool()
        state.connections.equipped = tool.Equipped:Connect(onEquip)
        state.connections.unequipped = tool.Unequipped:Connect(onUnequip)
        state.connections.activated = tool.Activated:Connect(placeAction)
        state.connections.inputBegan = UserInputService.InputBegan:Connect(onInputBegan)
        state.connections.inputEnded = UserInputService.InputEnded:Connect(onInputEnded)
        wireGuiButtons()
    end

    local function cleanup()
        for k, conn in pairs(state.connections) do
            if conn and conn.Disconnect then
                pcall(function() conn:Disconnect() end)
            end
        end
        state.connections = {}
        state.active = false
        if BuildReplicator then
            BuildReplicator:ClearAllChildren()
        end
    end

    connectTool()

    return cleanup
end
