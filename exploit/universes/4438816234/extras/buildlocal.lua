return function(newParent)
	local Players = game:GetService("Players")
	local UserInputService = game:GetService("UserInputService")
	local ReplicatedStorage = game:GetService("ReplicatedStorage")
	local TweenService = game:GetService("TweenService")
	local CollectionService = game:GetService("CollectionService")
	local Workspace = game:GetService("Workspace")

	local player = Players.LocalPlayer
	local playerGui = player:WaitForChild("PlayerGui")
	local CurrentCamera = Workspace.CurrentCamera

	local Remotes = newParent:WaitForChild("Remotes")
	local PlaceRemote = Remotes:FindFirstChild("Place")
	local DestroyItemRemote = Remotes:FindFirstChild("DestroyItemRemote") or ReplicatedStorage:FindFirstChild("DestroyItemRemote")
	local ThrowItemEvent = ReplicatedStorage:FindFirstChild("ThrowItemEvent")
	local PlaceBuildRemoveItemEvent = ReplicatedStorage:FindFirstChild("PlaceBuildRemoveItemEvent")
	local BuildReplicatorPart = Workspace:WaitForChild("BuildReplicatorPart")

	local function safeRefresh()
		player = Players.LocalPlayer
		playerGui = player:WaitForChild("PlayerGui")
		CurrentCamera = Workspace.CurrentCamera
	end

	safeRefresh()

	local TheInventorySystem = playerGui:WaitForChild("TheInventorySystem")
	local InventoryMenu = TheInventorySystem:WaitForChild("InventoryMenu")
	local HotbarLine = InventoryMenu:WaitForChild("Inventory Section"):WaitForChild("Inv"):WaitForChild("HotbarLine")
	local HotbarContainer = TheInventorySystem:FindFirstChild("Hotbar")
	local SlotSelected = TheInventorySystem:WaitForChild("SlotSelected")
	local InvGui = InventoryMenu["Inventory Section"].Inv
	local StorageGui = InventoryMenu["HomeCore Section"].Storage

	local MobileButtons = playerGui:WaitForChild("MobileButtons")
	local RotateGui = MobileButtons:WaitForChild("Rotate")
	local RotateBtn = RotateGui:WaitForChild("RotateButton")
	local ForwardGui = MobileButtons:WaitForChild("MoveForward")
	local ForwardBtn = ForwardGui:WaitForChild("ForwardButton")
	local BackGui = MobileButtons:WaitForChild("MoveBackward")
	local BackBtn = BackGui:WaitForChild("BackwardButton")

	local XYZ = playerGui:WaitForChild("XYZ")
	local Xbtn = XYZ:WaitForChild("X")
	local Ybtn = XYZ:WaitForChild("Y")
	local Zbtn = XYZ:WaitForChild("Z")
	local CheckmarkGUI = XYZ:WaitForChild("CheckmarkGUI")

	local defaultDistance = 8.25
	local distance = defaultDistance
	local rotateAccum = Vector3.new(0,0,0)
	local placingEnabled = false
	local rotating = false
	local forwardHold = false
	local backHold = false
	local axisX, axisY, axisZ = true, false, false

	local function updateMobileSizes()
		local size = 120
		local ok, screenX = pcall(function() return RotateBtn.Screen.AbsoluteSize.X end)
		local ok2, screenY = pcall(function() return RotateBtn.Screen.AbsoluteSize.Y end)
		if ok and ok2 and math.min(screenX, screenY) > 500 then
			size = 70
		end
		if UserInputService.TouchEnabled then
			if RotateGui then RotateGui.Enabled = true end
			if ForwardGui then ForwardGui.Enabled = true end
			if BackGui then BackGui.Enabled = true end
			if RotateBtn then RotateBtn.Size = UDim2.new(0, size, 0, size) end
			if ForwardBtn then ForwardBtn.Size = UDim2.new(0, size, 0, size) end
			if BackBtn then BackBtn.Size = UDim2.new(0, size, 0, size) end
		else
			if RotateGui then RotateGui.Enabled = false end
			if ForwardGui then ForwardGui.Enabled = false end
			if BackGui then BackGui.Enabled = false end
		end
	end

	local function safeWaitChar()
		if not player.Character then
			player.CharacterAdded:Wait()
		end
	end

	local function getHotbarSlotGui()
		local slot = SlotSelected and SlotSelected.Value
		if not slot or not HotbarLine then return nil end
		if slot == 2 then return HotbarLine:FindFirstChild("InvSlot2")
		elseif slot == 3 then return HotbarLine:FindFirstChild("InvSlot3")
		elseif slot == 4 then return HotbarLine:FindFirstChild("InvSlot4")
		elseif slot == 5 then return HotbarLine:FindFirstChild("InvSlot5")
		elseif slot == 6 then return HotbarLine:FindFirstChild("InvSlot6")
		elseif slot == 7 then return HotbarLine:FindFirstChild("InvSlot7")
		elseif slot == 8 then return HotbarLine:FindFirstChild("InvSlot8")
		elseif slot == 9 then return HotbarLine:FindFirstChild("InvSlot9")
		elseif slot == 10 then return HotbarLine:FindFirstChild("InvSlot10")
		end
		return nil
	end

	local function findSelectedInventoryButton(slotGui)
		if not slotGui then return nil end
		for _, child in ipairs(slotGui:GetChildren()) do
			if child:IsA("ImageButton") then
				return child
			end
		end
		return nil
	end

	local function canPlaceRegardless()
		if not newParent or not newParent:IsA("Tool") then return true end
		if CollectionService:HasTag(newParent, "ETHICAL") then return false end
		local tagFolder = newParent:FindFirstChild("Tags")
		if tagFolder and tagFolder:FindFirstChild("ETHICAL") then return false end
		return true
	end

	UserInputService.InputBegan:Connect(function(input, processed)
		if not processed then
			if input.KeyCode == Enum.KeyCode.V and placingEnabled then forwardHold = true end
			if input.KeyCode == Enum.KeyCode.B and placingEnabled then backHold = true end
			if input.KeyCode == Enum.KeyCode.R and placingEnabled then
				if not rotating then
					rotating = true
					spawn(function()
						while rotating do
							if axisX then rotateAccum = rotateAccum + Vector3.new(45,0,0)
							elseif axisY then rotateAccum = rotateAccum + Vector3.new(0,45,0)
							elseif axisZ then rotateAccum = rotateAccum + Vector3.new(0,0,45) end
							wait(0.25)
						end
					end)
				end
			end
		end
	end)
	UserInputService.InputEnded:Connect(function(input)
		if input.KeyCode == Enum.KeyCode.V and placingEnabled then forwardHold = false end
		if input.KeyCode == Enum.KeyCode.B and placingEnabled then backHold = false end
		if input.KeyCode == Enum.KeyCode.R and placingEnabled then rotating = false end
	end)

	ForwardBtn.MouseButton1Down:Connect(function() if placingEnabled then forwardHold = true end end)
	ForwardBtn.MouseButton1Up:Connect(function() if placingEnabled then forwardHold = false end end)
	BackBtn.MouseButton1Down:Connect(function() if placingEnabled then backHold = true end end)
	BackBtn.MouseButton1Up:Connect(function() if placingEnabled then backHold = false end end)

	Xbtn.Activated:Connect(function() if placingEnabled then axisX,axisY,axisZ = true,false,false Xbtn.Image = "rbxassetid://16562623753" Ybtn.Image = "rbxassetid://16562604900" Zbtn.Image = "rbxassetid://16562606076" end end)
	Ybtn.Activated:Connect(function() if placingEnabled then axisX,axisY,axisZ = false,true,false Xbtn.Image = "rbxassetid://16562628313" Ybtn.Image = "rbxassetid://16562630011" Zbtn.Image = "rbxassetid://16562606076" end end)
	Zbtn.Activated:Connect(function() if placingEnabled then axisX,axisY,axisZ = false,false,true Xbtn.Image = "rbxassetid://16562628313" Ybtn.Image = "rbxassetid://16562604900" Zbtn.Image = "rbxassetid://16562632722" end end)

	local function onEquipped()
		placingEnabled = true
		safeRefresh()
		BuildReplicatorPart:ClearAllChildren()
		rotateAccum = Vector3.new(0,0,0)
		distance = defaultDistance
		if TheInventorySystem and TheInventorySystem:FindFirstChild("KeyboardControlsList") and TheInventorySystem.KeyboardControlsList:FindFirstChild("ItemControls") and not UserInputService.TouchEnabled then
			TheInventorySystem.KeyboardControlsList.ItemControls.Image = "rbxassetid://17223334384"
		end
		if XYZ then XYZ.Enabled = true end
		if RotateGui then RotateGui.Enabled = UserInputService.TouchEnabled end
		if ForwardGui then ForwardGui.Enabled = UserInputService.TouchEnabled end
		if BackGui then BackGui.Enabled = UserInputService.TouchEnabled end
		while placingEnabled do
			CurrentCamera = Workspace.CurrentCamera
			local camPos = CurrentCamera.CFrame.Position
			if forwardHold and distance < 12.5 then distance = distance + 0.3 end
			if backHold and distance > 4 then distance = distance - 0.3 end
			local targetCFrame = CFrame.new(camPos + CurrentCamera.CFrame.LookVector * distance) * CFrame.fromEulerAnglesXYZ(math.rad(rotateAccum.X), math.rad(rotateAccum.Y), math.rad(rotateAccum.Z))
			if BuildReplicatorPart and TweenService then
				local tween = TweenService:Create(BuildReplicatorPart, TweenInfo.new(0.25), {CFrame = targetCFrame})
				tween:Play()
				tween.Completed:Wait()
			end
			local collision = false
			if BuildReplicatorPart then
				for _, child in ipairs(BuildReplicatorPart:GetChildren()) do
					if child and (child:IsA("Part") or child:IsA("MeshPart")) then
						for _, touching in ipairs(child:GetTouchingParts()) do
							if touching and touching.Parent and touching.Parent ~= BuildReplicatorPart and touching.Parent ~= player.Character then
								collision = true
								break
							end
						end
					end
					if collision then break end
				end
			end
			if CheckmarkGUI then
				if collision then CheckmarkGUI.Image = "rbxassetid://16629629912" else CheckmarkGUI.Image = "rbxassetid://16629665367" end
			end
			wait()
		end
	end

	local function onUnequipped()
		placingEnabled = false
		if XYZ then XYZ.Enabled = false end
		if RotateGui then RotateGui.Enabled = false end
		if ForwardGui then ForwardGui.Enabled = false end
		if BackGui then BackGui.Enabled = false end
		if BuildReplicatorPart then BuildReplicatorPart:ClearAllChildren() end
	end

	newParent.Equipped:Connect(onEquipped)
	newParent.Unequipped:Connect(onUnequipped)

	local function safeDestroyHotbarVisuals()
		if not HotbarContainer then return end
		for _, hb in ipairs(HotbarContainer:GetChildren()) do
			local num = tonumber(hb.Name:match("%d+$"))
			if num and SlotSelected and num == SlotSelected.Value then
				for _, child in ipairs(hb:GetChildren()) do
					if child and child.Name == newParent.Name then
						child:Destroy()
					end
				end
			end
		end
	end

	local function placeAction()
		local slotGui = getHotbarSlotGui()
		if not slotGui then return end
		local selectedBtn = findSelectedInventoryButton(slotGui)
		if not selectedBtn then return end
		local invParent = selectedBtn.Parent
		if not invParent then return end
		local grandParent = invParent.Parent
		if not grandParent then return end
		local highestParent = grandParent.Parent

		if highestParent == InvGui then
			if not canPlaceRegardless() then
				local found = StorageGui and StorageGui[grandParent.Name] and StorageGui[grandParent.Name][invParent.Name] and StorageGui[grandParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name)
				if found then found:SetAttribute("DeleteItem", true) end
			end
		elseif highestParent == StorageGui then
			if not canPlaceRegardless() then
				local found = InvGui and InvGui[grandParent.Name] and InvGui[grandParent.Name][invParent.Name] and InvGui[grandParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name)
				if found then found:SetAttribute("DeleteItem", true) end
			end
		end

		safeDestroyHotbarVisuals()

		if placingEnabled then
			local unequipRemote = TheInventorySystem and TheInventorySystem:FindFirstChild("UnEquipRemote")
			if unequipRemote then unequipRemote:FireServer() end
			if PlaceBuildRemoveItemEvent and slotGui and selectedBtn then
				PlaceBuildRemoveItemEvent:FireServer(slotGui, selectedBtn)
			end
			if PlaceRemote then PlaceRemote:FireServer() end
			if DestroyItemRemote and (not canPlaceRegardless()) then
				local delayTime = 0.1
				if PlaceRemote and PlaceRemote:IsA("Sound") and PlaceRemote.TimeLength then delayTime = PlaceRemote.TimeLength end
				wait(delayTime)
				DestroyItemRemote:FireServer()
			end
		end
	end

	newParent.Activated:Connect(placeAction)

	RotateBtn.MouseButton1Down:Connect(function()
		if placingEnabled and not rotating then
			rotating = true
			spawn(function()
				while rotating do
					if axisX then rotateAccum = rotateAccum + Vector3.new(45,0,0)
					elseif axisY then rotateAccum = rotateAccum + Vector3.new(0,45,0)
					elseif axisZ then rotateAccum = rotateAccum + Vector3.new(0,0,45) end
					wait(0.25)
				end
			end)
		end
	end)
	RotateBtn.MouseButton1Up:Connect(function() rotating = false end)

	UserInputService.InputBegan:Connect(function(input, processed)
		if processed then return end
		if input.KeyCode == Enum.KeyCode.T then
			local slotGui = getHotbarSlotGui()
			if not slotGui then return end
			local selectedBtn = findSelectedInventoryButton(slotGui)
			if not selectedBtn then return end
			safeDestroyHotbarVisuals()
			local unequipRemote = TheInventorySystem and TheInventorySystem:FindFirstChild("UnEquipRemote")
			if unequipRemote then unequipRemote:FireServer() end
			if ThrowItemEvent then
				local char = player.Character or player.CharacterAdded:Wait()
				local torsoPos = Vector3.new()
				if char then
					local hrp = char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
					if hrp then torsoPos = hrp.Position end
				end
				local look = CurrentCamera and CurrentCamera.CFrame.LookVector or Vector3.new(0,0,-1)
				local dir = (look * 100 - torsoPos)
				local velocity = Vector3.new()
				if dir.Magnitude > 0 then velocity = dir.Unit * 30 end
				ThrowItemEvent:FireServer(slotGui, HotbarLine, newParent, selectedBtn, player.Character or player.CharacterAdded:Wait(), velocity)
			end
			wait()
			local invParent = selectedBtn.Parent
			local grandParent = invParent and invParent.Parent
			local highestParent = grandParent and grandParent.Parent
			if highestParent == InvGui then
				if not canPlaceRegardless() and StorageGui and StorageGui[grandParent.Name] and StorageGui[grandParent.Name][invParent.Name] then
					local found = StorageGui[grandParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name)
					if found then found:SetAttribute("DeleteItem", true) end
				end
			elseif highestParent == StorageGui then
				if not canPlaceRegardless() and InvGui and InvGui[grandParent.Name] and InvGui[grandParent.Name][invParent.Name] then
					local found = InvGui[grandParent.Name][invParent.Name]:FindFirstChild(selectedBtn.Name)
					if found then found:SetAttribute("DeleteItem", true) end
				end
			end
			if DestroyItemRemote and (not canPlaceRegardless()) then
				DestroyItemRemote:FireServer()
			end
		end
	end)

end
