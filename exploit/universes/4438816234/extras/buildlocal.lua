local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local workspace = workspace

return function(newParent)
    local LocalPlayer = Players.LocalPlayer
    local playerGui = LocalPlayer:WaitForChild("PlayerGui")
    local tool = newParent
    local RemotesFolder = tool:WaitForChild("Remotes")
    local EquippedRemote = RemotesFolder:WaitForChild("Equipped")
    local PlaceRemote = RemotesFolder:FindFirstChild("Place")
    local DestroyItemRemote = RemotesFolder:FindFirstChild("DestroyItemRemote")
    local UnEquipRemoteGui = playerGui.TheInventorySystem:FindFirstChild("UnEquipRemote")
    local PlaceBuildRemoveItemEvent = ReplicatedStorage:FindFirstChild("PlaceBuildRemoveItemEvent")
    local ThrowItemEvent = ReplicatedStorage:FindFirstChild("ThrowItemEvent")
    local BuildReplicatorPart = workspace:WaitForChild("BuildReplicatorPart")
    local PlaceSound = tool:FindFirstChild("PlaceSound")
    local CurrentCamera = workspace.CurrentCamera

    local settings = {
        startDistance = 8.25,
        minDistance = 4,
        maxDistance = 12.5,
        rotateStep = 45,
        rotateHoldInterval = 0.25
    }

    local state = {
        active = false,
        forwardHeld = false,
        backwardHeld = false,
        rotateHold = false,
        rotateLoop = false,
        rotateAxisX = true,
        rotateAxisY = false,
        rotateAxisZ = false,
        rotateVector = Vector3.new(0,0,0),
        distance = settings.startDistance,
        canFlipRotateLoop = true,
        invalidPlacement = false
    }

    local HotbarLine, Hotbar, InvFolder, StorageFolder, SlotSelected
    local MobileRotate, MobileForward, MobileBackward, RotateButton, ForwardButton, BackwardButton
    local XYZgui, Xbtn, Ybtn, Zbtn, CheckmarkGUI

    local function getAllGuiRefs()
        HotbarLine = playerGui.TheInventorySystem.InventoryMenu["Inventory Section"].Inv.HotbarLine
        Hotbar = playerGui.TheInventorySystem.Hotbar
        InvFolder = playerGui.TheInventorySystem.InventoryMenu["Inventory Section"].Inv
        StorageFolder = playerGui.TheInventorySystem.InventoryMenu["HomeCore Section"].Storage
        SlotSelected = playerGui.TheInventorySystem.SlotSelected
        MobileRotate = LocalPlayer.PlayerGui.MobileButtons:WaitForChild("Rotate")
        RotateButton = MobileRotate:WaitForChild("RotateButton")
        MobileForward = LocalPlayer.PlayerGui.MobileButtons:WaitForChild("MoveForward")
        ForwardButton = MobileForward:WaitForChild("ForwardButton")
        MobileBackward = LocalPlayer.PlayerGui.MobileButtons:WaitForChild("MoveBackward")
        BackwardButton = MobileBackward:WaitForChild("BackwardButton")
        XYZgui = playerGui:FindFirstChild("XYZ")
        if XYZgui then
            Xbtn = XYZgui:FindFirstChild("X")
            Ybtn = XYZgui:FindFirstChild("Y")
            Zbtn = XYZgui:FindFirstChild("Z")
            CheckmarkGUI = XYZgui:FindFirstChild("CheckmarkGUI")
        end
    end

    getAllGuiRefs()

    local function mapSlotToGui(slot)
        if not HotbarLine then return nil end
        if slot == 1 then return HotbarLine.InvSlot1 end
        if slot == 2 then return HotbarLine.InvSlot2 end
        if slot == 3 then return HotbarLine.InvSlot3 end
        if slot == 4 then return HotbarLine.InvSlot4 end
        if slot == 5 then return HotbarLine.InvSlot5 end
        if slot == 6 then return HotbarLine.InvSlot6 end
        if slot == 7 then return HotbarLine.InvSlot7 end
        if slot == 8 then return HotbarLine.InvSlot8 end
        if slot == 9 then return HotbarLine.InvSlot9 end
        if slot == 10 then return HotbarLine.InvSlot10 end
        return nil
    end

    local function findImageButtonIn(slotGui)
        if not slotGui then return nil end
        for _, c in ipairs(slotGui:GetChildren()) do
            if c:IsA("ImageButton") then
                return c
            end
        end
        return nil
    end

    local function rebuildPreview()
        BuildReplicatorPart:ClearAllChildren()
        local buildTemplate = ReplicatedStorage.Builds and ReplicatedStorage.Builds[tool.Name]
        if not buildTemplate then return end
        for _, v in ipairs(buildTemplate:GetDescendants()) do
            if v:IsA("Part") or v:IsA("MeshPart") then
                local clone = v:Clone()
                clone.Parent = BuildReplicatorPart
                clone.CFrame = BuildReplicatorPart.CFrame * CFrame.new(v.Position)
                if v.Name ~= "BarrierPart" and v.Name ~= "Epart" and v.Name ~= "PrimPart" and v.Name ~= "OpenPos" then
                    clone.Transparency = 0.4
                end
                pcall(function() clone.CollisionGroup = "Builds" end)
                local weld = Instance.new("WeldConstraint")
                weld.Part0 = BuildReplicatorPart
                weld.Part1 = clone
                weld.Parent = clone
            end
        end
    end

    local function updateReplicatorCFrame()
        if not state.active then return end
        CurrentCamera = workspace.CurrentCamera
        local lookPos = CurrentCamera.CFrame.Position + CurrentCamera.CFrame.LookVector * state.distance
        local rot = CFrame.fromEulerAnglesXYZ(math.rad(state.rotateVector.X), math.rad(state.rotateVector.Y), math.rad(state.rotateVector.Z))
        local target = CFrame.new(lookPos) * rot
        TweenService:Create(BuildReplicatorPart, TweenInfo.new(0.25), {CFrame = target}):Play()
    end

    local function canPlaceNow()
        local canPlace = true
        for _, child in ipairs(BuildReplicatorPart:GetChildren()) do
            if (child:IsA("Part") or child:IsA("MeshPart")) and child.Name ~= "BarrierPart" then
                for _, touching in ipairs(child:GetTouchingParts()) do
                    if touching and touching.Parent then
                        if touching.Parent ~= BuildReplicatorPart and touching.Parent ~= (LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()) then
                            local anti = touching:GetAttribute("AntiBuild") or touching.Parent:GetAttribute("AntiBuild")
                            if anti ~= true then
                                canPlace = false
                                break
                            end
                        end
                    end
                end
                if not canPlace then break end
            end
        end
        state.invalidPlacement = not canPlace
        if CheckmarkGUI then
            if canPlace then
                CheckmarkGUI.Image = "rbxassetid://16629665367"
            else
                CheckmarkGUI.Image = "rbxassetid://16629629912"
            end
        end
        return canPlace
    end

    local function startRotateHold()
        if state.rotateHold then return end
        state.rotateHold = true
        state.rotateLoop = true
        if state.rotateAxisX then
            state.rotateVector = state.rotateVector + Vector3.new(settings.rotateStep,0,0)
        elseif state.rotateAxisY then
            state.rotateVector = state.rotateVector + Vector3.new(0,settings.rotateStep,0)
        else
            state.rotateVector = state.rotateVector + Vector3.new(0,0,settings.rotateStep)
        end
        updateReplicatorCFrame()
        task.wait(settings.rotateHoldInterval)
        while state.rotateLoop do
            if state.rotateAxisX then
                state.rotateVector = state.rotateVector + Vector3.new(settings.rotateStep,0,0)
            elseif state.rotateAxisY then
                state.rotateVector = state.rotateVector + Vector3.new(0,settings.rotateStep,0)
            else
                state.rotateVector = state.rotateVector + Vector3.new(0,0,settings.rotateStep)
            end
            updateReplicatorCFrame()
            task.wait(settings.rotateHoldInterval)
        end
        state.rotateHold = false
    end

    local function showXYZ(b)
        if XYZgui then
            XYZgui.Enabled = b
        end
    end

    local function onEquipped()
        state.active = true
        state.distance = settings.startDistance
        state.rotateVector = Vector3.new(0,0,0)
        showXYZ(true)
        CurrentCamera = workspace.CurrentCamera
        BuildReplicatorPart.CFrame = CFrame.new(CurrentCamera.CFrame.Position + CurrentCamera.CFrame.LookVector * state.distance) * CFrame.fromEulerAnglesXYZ(0,0,0)
        rebuildPreview()
        updateReplicatorCFrame()
        pcall(function() EquippedRemote:FireServer(LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()) end)
        task.spawn(function()
            while state.active do
                CurrentCamera = workspace.CurrentCamera
                if state.forwardHeld and state.distance < settings.maxDistance then
                    state.distance = math.min(settings.maxDistance, state.distance + 0.3)
                elseif state.backwardHeld and state.distance > settings.minDistance then
                    state.distance = math.max(settings.minDistance, state.distance - 0.3)
                end
                updateReplicatorCFrame()
                canPlaceNow()
                task.wait(0.05)
            end
        end)
    end

    local function onUnequipped()
        state.active = false
        showXYZ(false)
        BuildReplicatorPart:ClearAllChildren()
    end

    local function doPlace()
        if not state.active then return end
        if not canPlaceNow() then return end
        local slotGui = mapSlotToGui(SlotSelected and SlotSelected.Value or 1)
        local imgBtn = findImageButtonIn(slotGui)
        if imgBtn then
            if imgBtn.Parent and imgBtn.Parent.Parent and imgBtn.Parent.Parent.Parent == InvFolder then
                StorageFolder[imgBtn.Parent.Parent.Name][imgBtn.Parent.Name]:FindFirstChild(imgBtn.Name):SetAttribute("DeleteItem", true)
            elseif imgBtn.Parent and imgBtn.Parent.Parent and imgBtn.Parent.Parent.Parent == StorageFolder then
                InvFolder[imgBtn.Parent.Parent.Name][imgBtn.Parent.Name]:FindFirstChild(imgBtn.Name):SetAttribute("DeleteItem", true)
            end
        end
        if UnEquipRemoteGui then
            pcall(function() UnEquipRemoteGui:FireServer() end)
        end
        if PlaceBuildRemoveItemEvent and slotGui and imgBtn then
            pcall(function() PlaceBuildRemoveItemEvent:FireServer(slotGui, imgBtn) end)
        end
        if PlaceSound and PlaceSound:IsA("Sound") then
            pcall(function() PlaceSound:Play() end)
            task.wait(PlaceSound.TimeLength)
        end
        if DestroyItemRemote then
            pcall(function() DestroyItemRemote:FireServer() end)
        end
    end

    local function doThrow()
        if not state.active then return end
        local slotNum = SlotSelected and SlotSelected.Value or 1
        local slotGui = mapSlotToGui(slotNum)
        local imgBtn = findImageButtonIn(slotGui)
        for _, v in ipairs(Hotbar:GetChildren()) do
            if tonumber(v.Name:match("%d+$")) == slotNum then
                for _, child in ipairs(v:GetChildren()) do
                    if child.Name == tool.Name then
                        child:Destroy()
                    end
                end
            end
        end
        if UnEquipRemoteGui then
            pcall(function() UnEquipRemoteGui:FireServer() end)
        end
        local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local torsoPos = (char:FindFirstChild("Torso") and char.Torso.Position) or (char:FindFirstChild("HumanoidRootPart") and char.HumanoidRootPart.Position) or (char.PrimaryPart and char.PrimaryPart.Position) or Vector3.new()
        CurrentCamera = workspace.CurrentCamera
        local lookVec = CurrentCamera.CFrame.LookVector
        local throwVec = (lookVec * 100 - torsoPos)
        local velocity = (throwVec.Magnitude > 0 and throwVec.Unit * 30) or Vector3.new(0,0,0)
        if ThrowItemEvent then
            pcall(function() ThrowItemEvent:FireServer(slotGui, HotbarLine, tool, imgBtn, char, velocity) end)
        end
        task.wait()
        if DestroyItemRemote then
            pcall(function() DestroyItemRemote:FireServer() end)
        end
        if imgBtn and imgBtn.Parent and imgBtn.Parent.Parent and imgBtn.Parent.Parent.Parent == InvFolder then
            StorageFolder[imgBtn.Parent.Parent.Name][imgBtn.Parent.Name]:FindFirstChild(imgBtn.Name):SetAttribute("DeleteItem", true)
            return
        end
        if imgBtn and imgBtn.Parent and imgBtn.Parent.Parent and imgBtn.Parent.Parent.Parent == StorageFolder then
            InvFolder[imgBtn.Parent.Parent.Name][imgBtn.Parent.Name]:FindFirstChild(imgBtn.Name):SetAttribute("DeleteItem", true)
        end
    end

    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.V and state.active then
            state.forwardHeld = true
        elseif input.KeyCode == Enum.KeyCode.B and state.active then
            state.backwardHeld = true
        elseif input.KeyCode == Enum.KeyCode.R and state.active and state.canFlipRotateLoop then
            state.rotateLoop = true
            task.spawn(startRotateHold)
        elseif input.KeyCode == Enum.KeyCode.T and state.active then
            doThrow()
        elseif input.KeyCode == Enum.KeyCode.X and state.active then
            state.rotateAxisX = true
            state.rotateAxisY = false
            state.rotateAxisZ = false
        elseif input.KeyCode == Enum.KeyCode.Y and state.active then
            state.rotateAxisX = false
            state.rotateAxisY = true
            state.rotateAxisZ = false
        elseif input.KeyCode == Enum.KeyCode.Z and state.active then
            state.rotateAxisX = false
            state.rotateAxisY = false
            state.rotateAxisZ = true
        end
    end)

    UserInputService.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.V then
            state.forwardHeld = false
        elseif input.KeyCode == Enum.KeyCode.B then
            state.backwardHeld = false
        elseif input.KeyCode == Enum.KeyCode.R then
            state.rotateLoop = false
        end
    end)

    local function wireMobile()
        if RotateButton then
            RotateButton.MouseButton1Down:Connect(function()
                if state.canFlipRotateLoop then
                    state.rotateLoop = true
                    task.spawn(startRotateHold)
                end
            end)
            RotateButton.MouseButton1Up:Connect(function()
                state.rotateLoop = false
            end)
        end
        if ForwardButton then
            ForwardButton.MouseButton1Down:Connect(function()
                state.forwardHeld = true
            end)
            ForwardButton.MouseButton1Up:Connect(function()
                state.forwardHeld = false
            end)
        end
        if BackwardButton then
            BackwardButton.MouseButton1Down:Connect(function()
                state.backwardHeld = true
            end)
            BackwardButton.MouseButton1Up:Connect(function()
                state.backwardHeld = false
            end)
        end
        if Xbtn then
            Xbtn.Activated:Connect(function()
                if state.active then
                    state.rotateAxisX = true
                    state.rotateAxisY = false
                    state.rotateAxisZ = false
                end
            end)
        end
        if Ybtn then
            Ybtn.Activated:Connect(function()
                if state.active then
                    state.rotateAxisX = false
                    state.rotateAxisY = true
                    state.rotateAxisZ = false
                end
            end)
        end
        if Zbtn then
            Zbtn.Activated:Connect(function()
                if state.active then
                    state.rotateAxisX = false
                    state.rotateAxisY = false
                    state.rotateAxisZ = true
                end
            end)
        end
    end

    tool.Equipped:Connect(function()
        getAllGuiRefs()
        onEquipped()
    end)

    tool.Unequipped:Connect(function()
        onUnequipped()
    end)

    tool.Activated:Connect(function()
        doPlace()
    end)

    wireMobile()

    local function cleanup()
        BuildReplicatorPart:ClearAllChildren()
        showXYZ(false)
        state.active = false
    end

    return cleanup
end
